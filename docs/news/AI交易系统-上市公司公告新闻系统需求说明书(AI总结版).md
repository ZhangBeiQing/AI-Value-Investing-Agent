# AI交易系统 - 上市公司公告新闻系统需求说明书（AI总结版，兼容版PRD）

## 1. 项目背景与目标
- 以“公司官方公告”作为主要新闻源，为 AI 交易 Agent 提供权威、低噪声、可回测的资讯流。
- 解决长文高成本、冗余公告、回测时“未来函数”泄露等问题；与现有缓存与目录结构完全兼容。
- 保证每只股票的公告 PDF“只下载一次”，并通过索引与TTL实现每日增量更新。

## 2. 术语与范围
- `仿真日期`：用于回测的当前日期，仅返回该日期及之前的数据。
- `原子化摘要`：每份公告由初级模型生成一条结构化 JSON 摘要，用于快速提取事实。
- `战略审计`：由更强的审计模型对“原子化摘要”进行二次分析、去重、修正并深化洞察。
- 范围：A股（沪深京）公告，覆盖一般公告与定期报告（年报/季报等）。

## 3. 数据源与接口
- 使用 `akshare.stock_zh_a_disclosure_report_cninfo` 获取指定区间内的公告列表（代码、标题、时间、链接等）。
- 首次入池默认抓取过去 1 年的公告；每日夜间检查增量（TTL=1天）。

## 4. 存储与目录规范（与项目兼容）
- 所有产物按股票分目录存放：`data/stock_info/<股票名_代码>/...`。
- 公告缓存目录：`disclosures/` 下包含：
  - `pdfs/`：原始 PDF，仅下载一次；文件命名为 `YYYY-MM-DD__<stockCode>__<announcementId>__<slug-title>.pdf`。
  - `md/`：**（新增）** 可选的 PDF→Markdown 转换产物，当所选模型不支持直接解析 PDF 时自动生成并缓存。
  - `index.json`：公告元数据索引，记录唯一键、下载/摘要状态、路径、模型 fileId 等。
- 新闻汇总：`news/news.json` 为按时间排序的、**经过战略审计后**的公告摘要总表，可直接替换现有 `news`。

## 5. 缓存策略（与 cache_registry 兼容）
- TTL 统一为 1 天：每日夜间对照 `index.json` 检查新增公告，增量下载与摘要。
- 通过唯一键（优先 `announcementId`，后备 `title+date` 哈希）去重，保证 PDF 只下载一次并避免重复摘要。
- **（新增）Markdown 缓存**：PDF到Markdown的转换结果将被缓存，避免重复处理。
- 接入现有缓存框架：构建目录与刷新标记使用 `build_cache_dir`、`record_cache_refresh`、`should_refresh`。

## 6. 核心功能需求
- 数据获取与清洗：
  - 拉取公告后进行规则过滤，排除低价值的行政性公告。
  - 自动识别“财报类公告”，单独路径处理。
- **（修订）两阶段摘要与审计流程**：
  - **第一阶段：原子化摘要生成**：每条新公告调用AI模型（如`Qwen-Doc-Turbo`）快速生成结构化 JSON，包含客观事实，并合入`news.json`。
  - **第二阶段：战略审计与精炼**：系统定期启动审计流程，使用一个更强大的、由用户指定的审计模型和专用的`AUDIT_AND_REFINE_PROMPT`。
    - **增量审核缓存机制（新增）**：若存在 `news_audited.json`，先读取其最新日期；若 `news.json` 最新日期不大于已审核最新日期，直接退出；若更大，则仅提取新增区间的数据提交给审核模型，并将输出**追加写入** `news_audited.json`，保持历史审核结果不变。
    - **分批更新（新增）**：当新增区间超过60天时，按60天为窗口分批调用审核模型，每批次完成后立即将结果追加保存，确保断点续审与可靠落盘。
- 首次入池：
  - 下载并处理过去 1 年公告，完成第一阶段的原子摘要生成，并随后触发一次完整的战略审计流程。
- 增量更新：
  - 每日夜间检查新增公告，生成原子摘要并合入 `news.json`。若启用增量审核缓存机制，则在检测到新增公告时仅对新增区间进行审核并写入 `news_audited.json`；新增区间超过60天则自动分批处理。
- 回测支持：
  - 严格防“未来函数”：仅返回仿真日期之前的数据。
- 审核模型保存：
  - 审核模型每批次结果完成后立即保存到 `news_audited.json`，确保断点续审与进度可恢复；原始内容保留在 `news.json`。

## 7. 模型与处理策略
- **（修订）PDF处理**：
  - **模型白名单**：系统内置一个可配置的列表（如 `SUPPORTED_DIRECT_PDF_MODELS`），包含 `Qwen-Doc-Turbo`、`Qwen-Long` 等支持PDF直读的模型。
  - **自动回退**：若用户选择的模型**不在**白名单内，系统将自动执行“PDF→Markdown→LLM”流程，并在索引中记录Markdown缓存路径。
- **（修订）模型分层**：
  - **原子摘要模型**：默认为 `Qwen-Doc-Turbo`，追求速度和性价比。
  - **战略审计模型**：由用户指定，应为能力更强的模型，用于深度分析和质量提升。
- 移除 Gemini 相关代码与自动搜索新闻功能；仅保留公告处理链路。

## 8. 财报的特殊处理
- 财报公告单独提取章节并生成“定性摘要”写入 `news.json`；全面的财务指标分析由独立模块负责，以免上下文冗余。

## 9. 非功能需求
- **性能与并发**：为提升批量处理效率，针对全量股票池的摘要生成与战略审计流程将采用多线程并发执行（每只股票一个独立线程），以大幅缩短处理时间。
- Token 与成本控制：优先使用PDF直读模型；Markdown缓存可减少重复转换开销。
- 可靠性与可恢复：索引驱动的去重下载与摘要，支持断点续传。

## 10. 兼容性与交付
- 目录与缓存遵循项目既有规范；产出的 `news.json` 可直接替换 `data/stock_info/<股票名_代码>/news` 现有内容。
